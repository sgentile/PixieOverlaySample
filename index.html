<!DOCTYPE html>
<html style="height: 100%; margin: 0;">
<head>
	<title>Pixi Prototype</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="/node_modules/leaflet/dist/leaflet.css" />
    <script src="/node_modules/leaflet/dist/leaflet.js"></script>
    <script src="/node_modules/pixi.js/dist/pixi.js"></script>
    <script src="/node_modules/leaflet-pixi-overlay/L.PixiOverlay.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script src="js/tools.min.js"></script>
    <link rel="stylesheet" type="text/css" href="cartes.css">
</head>
<body style="height: 100%; margin: 0; overflow: hidden;">
<div id="map" style="height: 100%; width: 100%;" class="cartes">
	<div class="legend geometry top center hide">
		<div class="wrapper">
			<div class="content"></div>
		</div>
	</div>
</div>
<script>	

	var loader = new PIXI.loaders.Loader();
	loader.add('marker', 'red-marker.png');
	document.addEventListener("DOMContentLoaded", function() {
		loader.load(function(loader, resources) {
			var textures = [resources.marker.texture];
            var focusTextures = [resources.marker.texture];

            var legend = document.querySelector('div.legend.geometry');
            var legendContent = legend.querySelector('.content');

            L.DomUtil.removeClass(legend, 'hide');
            legendContent.innerHTML = 'fetching records';
            const json = 'french-cities.json'; //;cities.json';
            axios.get(json).then((result) => {
                var markers = result.data;
                var map;
                    if(json === 'french-cities.json'){
                        map = L.map('map', {preferCanvas:true, renderer: L.canvas()}).setView([46.953387, 2.892341], 6);
                    } else if (json === 'cities.json'){
                        map = L.map('map', {preferCanvas:true, renderer: L.canvas()}).setView([37.49229399862877, -96.94335937500001], 4);
                    }
			
				L.tileLayer('//stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
					subdomains: 'abcd',
					attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
					minZoom: 4,
					maxZoom: 18
				}).addTo(map);
				map.attributionControl.setPosition('bottomleft');
				map.zoomControl.setPosition('bottomright');
                
                L.DomUtil.removeClass(legend, 'hide');
                legendContent.innerHTML = markers.length + ' records';
                var project;
                var markerSprites = [];
				var pixiLayer = (function() {
					var firstDraw = true;
					var prevZoom;					
					var colorScale = d3.scaleLinear()
						.domain([0, 50, 100])
						.range(["#c6233c", "#ffd300", "#008000"]);

					var frame = null;
					var focus = null;
					var pixiContainer = new PIXI.Container();
					var forceCanvas = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
					return L.pixiOverlay(function(utils) {
						var zoom = utils.getMap().getZoom();
						if (frame) {
							cancelAnimationFrame(frame);
							frame = null;
						}
						var container = utils.getContainer();
						var renderer = utils.getRenderer();
						project = utils.latLngToLayerPoint;
						var scale = utils.getScale();
						var invScale = 1 / scale;
						if (firstDraw) {
							prevZoom = zoom;
							markers.forEach(function(marker) {
								var coords = project([marker.latitude, marker.longitude]);
								var index = Math.floor(Math.random() * textures.length);
                                var markerSprite = new PIXI.Sprite(textures[index]);
                                markerSprite.buttonMode = true;
                                markerSprite.interactive = true;
                                markerSprite.on('mousedown', ()=>{
                                    L.DomUtil.removeClass(legend, 'hide');
                                    legendContent.innerHTML = marker.city || marker.label;
                                });
								markerSprite.textureIndex = index;
								markerSprite.x = coords.x;
								markerSprite.y = coords.y;
								markerSprite.anchor.set(0.5, 0.5);
								//var tint = d3.color(colorScale(marker.avancement || Math.random() * 100)).rgb();
								//markerSprite.tint = 256 * (tint.r * 256 + tint.g) + tint.b;
								container.addChild(markerSprite);
								markerSprites.push(markerSprite);
								markerSprite.legend = marker.city || marker.label;
                            });                                                                 
						}
						if (firstDraw || prevZoom !== zoom) {
							markerSprites.forEach(function(markerSprite) {
								if (firstDraw) {
									markerSprite.scale.set(invScale);
								} else {
									markerSprite.currentScale = markerSprite.scale.x;
									markerSprite.targetScale = invScale;
								}
							});
                        }
                                                                    

						var start = null;
						var delta = 250;
						function animate(timestamp) {
							var progress;
						  if (start === null) start = timestamp;
						  progress = timestamp - start;
						  var lambda = progress / delta;
						  if (lambda > 1) lambda = 1;
						  lambda = lambda * (0.4 + lambda * (2.2 + lambda * -1.6));
						  markerSprites.forEach(function(markerSprite) {
							  markerSprite.scale.set(markerSprite.currentScale + lambda * (markerSprite.targetScale - markerSprite.currentScale));
							});
							renderer.render(container);
						  if (progress < delta) {
						    frame = requestAnimationFrame(animate);
						  }
						}
						if (!firstDraw && prevZoom !== zoom) {
							frame = requestAnimationFrame(animate);
						}
						firstDraw = false;
						prevZoom = zoom;
						renderer.render(container);
					}, pixiContainer, {
						forceCanvas: forceCanvas
                    });
				})();

                pixiLayer.addTo(map);
                
                // function findMarker(ll) {                            
                //             // return markers.filter(m => {
                //             //     const markerLatLng = new L.LatLng(m.latitude, m.longitude);
                //             //     const selectedLatLng = new L.LatLng(ll.lat, ll.lng);      
                //             //     const zoom = map.getZoom(); 
                                
                //             //     //console.log(zoom); 
                //             //     let distanceTo = 0;                                
                //             //     if(zoom <= 5){
                //             //         distanceTo = 40000;
                //             //     }
                //             //     if(zoom > 5 && zoom < 7){
                //             //         distanceTo = 20000;
                //             //     }                     
                //             //     if(zoom > 7 && zoom < 8){
                //             //         distanceTo = 12000;
                //             //     }   
                //             //     if(zoom >= 8 && zoom < 9){
                //             //         distanceTo = 8000;
                //             //     }
                //             //     if(zoom >= 9 && zoom < 10){
                //             //         distanceTo = 3000;
                //             //     }
                //             //     if(zoom >= 10 && zoom < 11){
                //             //         distanceTo = 2000;
                //             //     }
                //             //     if(zoom >= 11 && zoom < 12){
                //             //         distanceTo = 1000;
                //             //     }
                //             //     if(zoom >= 12){
                //             //         distanceTo = 500;
                //             //     }
                //             //     if(zoom )
                //             //     if (selectedLatLng.distanceTo(markerLatLng) < distanceTo) {
                //             //         console.log(zoom, m);
                //             //         return m;
                //             //     };
                //             // })
                //             var quadTree = quadTrees[map.getZoom()];
                //             var marker;
                //             var rMax = quadTree.rMax;
                //             var found = false;
                //             quadTree.visit(function (quad, x1, y1, x2, y2) {
                //                 if (!quad.length) {
                //                     var dx = quad.data.x - layerPoint.x;
                //                     var dy = quad.data.y - layerPoint.y;
                //                     var r = quad.data.scale.x * 16;
                //                     if (dx * dx + dy * dy <= r * r) {
                //                         marker = quad.data;
                //                         found = true;
                //                     }
                //                 }
                //                 return found || x1 > layerPoint.x + rMax || x2 + rMax < layerPoint.x || y1 > layerPoint.y + rMax || y2 + rMax < layerPoint.y;
                //             });
                //             return marker;                            
                //         }

                // map.on('click', (e) => {
                //             var redraw = false;
                //             if (focus) {
                //                 focus.texture = textures[focus.textureIndex];
                //                 focus = null;
                //                 L.DomUtil.addClass(legend, 'hide');
                //                 legendContent.innerHTML = '';
                //                 redraw = true;
                //             }
                //             var markers = findMarker(e.latlng);
                //             legendContent.innerHTML = "";
                //             //console.log(markers);
                //             if (markers.length > 0) {
                //                 // marker.texture = focusTextures[marker.textureIndex];
                //                 // focus = marker;
                                
                //                 markers.forEach(m => {
                //                     legendContent.innerHTML += m.city + '<br/>';
                //                 })
                //                 //legendContent.innerHTML = marker.legend;
                //                 L.DomUtil.removeClass(legend, 'hide');
                //                 //redraw = true;
                //             }
                //             // if (redraw) utils.getRenderer().render(container);
                //         });
                // map.on('mousemove', L.Util.throttle((e) => {
                //             var markers = findMarker(e.latlng);
                            
                //             if (markers.length > 0) {  
                //                 markers.forEach(m => console.log(m));
                //                 L.DomUtil.addClass(map._container, 'crosshair-cursor-enabled');
                //             } else {
                //                 L.DomUtil.removeClass(map._container, 'crosshair-cursor-enabled');
                //             }
                //         }, 32));
			});
		});
	});
</script>
</body>
</html>
